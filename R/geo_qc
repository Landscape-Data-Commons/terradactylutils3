

#################################
#' geoSpecies QC
#'
#'produces a CSV with information about the QC of the geoSpecies file
#'
#' @param path_foringest path to where geoSpecies file is stored
#' @param USDA_plants as a data.frame, a file containing the accepted USDA codes with a code, GrowthHabit and Duration column
#' @param speciescode the name of the column with the 4 letter USDA codes in the USDA_plants file
#' @param path_qc path where the QC data will be saved
#'
#' @return a CSV with information about the QC of the geoSpecies file
#' @export
#'
#' @examples geospecies_qc(path_foringest = path_foringest, USDA_plants = read.csv("D:/modifying_data_prep_script_10032025/2004-2023_ceap_species_list.csv"), speciescode = "UpdatedSpeciesCode", path_qc = file.path("D:/modifying_data_prep_script_10032025/NWERN_HAFB_10132025/QC"))
geospecies_qc <- function(path_foringest, USDA_plants, speciescode, path_qc){

  a2 <- read.csv(paste0(path_foringest, "/geoSpecies.csv"))

  # list species < 4 char
  issue_codes_char <- a2[nchar(a2$Species) <= 3, ]

  if(nrow(issue_codes_char >0)){
    issue_codes_char$Notes <- "The species code is less than the expected 4 characters"
    issue_codes_char <- issue_codes_char |> dplyr::select(ProjectKey, PrimaryKey, Species, Notes)
  }

  #list any with NA GH or duration
  issue_codes_GH <- a2[is.na(a2$GrowthHabit),]
  if(nrow(issue_codes_GH >0)){
    issue_codes_GH$Notes <- "The GrowthHabit is NA"
    issue_codes_GH <- issue_codes_GH |> dplyr::select(ProjectKey, PrimaryKey, Species, Notes)
  }

  issue_codes_D <- a2[is.na(a2$Duration),]

  if(nrow(issue_codes_D >0)){
    issue_codes_D$Notes <- "The Duration is NA"
    issue_codes_D <- issue_codes_D |> dplyr::select(ProjectKey, PrimaryKey, Species, Notes)
  }

  # checking that the geospecies codes are in the USDA database
  USDA_plant_codes <- USDA_plants[,paste0(speciescode)]
  `%notin%` <- Negate(`%in%`)
  incorrect_code_sp <- a2[a2$code %notin% USDA_plant_codes,]

  if(nrow(incorrect_code_sp >0)){
    incorrect_code_sp$Notes <- "Species code not associated with a USDA plant code"
    incorrect_code_sp <- incorrect_code_sp |> dplyr::select(ProjectKey, PrimaryKey, Species, Notes)
  }


  incorrect_codes <-  rbind(issue_codes_char, issue_codes_GH) %>%
    rbind(., issue_codes_D) %>% rbind(., incorrect_code_sp)

  if(nrow(incorrect_codes >0)){
    incorrect_codes$Action <- "Work with the project manager to determine the correct species code and attributes"
  }

  write.csv(incorrect_codes, file.path(path_qc, "geoSpecies_code_check.csv"), row.names = FALSE)

}
##############################################



##############################################
#' Format for ingest files
#'
#' updates the files in the path_foringest path to have the correct DBKey and DateLoadedInDb
#'
#' @param path_foringest path where data for ingest are saved
#' @param DateLoadedInDb in standard date format, the date you are running the code
#'
#' @return CSVs of the for ingest files saved to the specified path_foringest
#' @export
#'
#' @examples db_info(path_foringest = path_foringest,  DateLoadedInDb = format(Sys.Date(), "%m/%d/%Y"))
db_info <- function(path_foringest, DateLoadedInDb){

  # read in data
  header <- read.csv(paste0(path_foringest, "/dataHeader.csv"))
  ind <- read.csv(paste0(path_foringest, "/geoIndicators.csv"))
  if(file.exists(file.path(path_foringest, "/dataLPI.csv"))) {
    LPI <- read.csv(paste0(path_foringest, "/dataLPI.csv"))}
  if(file.exists(file.path(path_foringest, "/dataGap.csv"))){
    gap <- read.csv(paste0(path_foringest, "/dataGap.csv"))}
  if(file.exists(file.path(path_foringest, "/dataSoilStability.csv"))){
    ss <- read.csv(paste0(path_foringest, "/dataSoilStability.csv"))}
  if(file.exists(file.path(path_foringest, "/dataHeight.csv"))) {
    hgt <- read.csv(paste0(path_foringest, "/dataHeight.csv"))}
  if(file.exists(file.path(path_foringest, "/geoSpecies.csv"))){
    sp <- read.csv(paste0(path_foringest, "/geoSpecies.csv"))}
  if(file.exists(file.path(path_foringest, "/dataSpeciesInventory.csv"))){
    spin <- read.csv(paste0(path_foringest, "/dataSpeciesInventory.csv"))}


  header$DateLoadedInDb <- rep(todaysDate)
  ind$DateLoadedInDb <- header$DateLoadedInDb[match(ind$PrimaryKey, header$PrimaryKey)]

  if(file.exists(file.path(path_foringest, "/dataLPI.csv"))) {
    LPI$DateLoadedInDb <- header$DateLoadedInDb[match(LPI$PrimaryKey, header$PrimaryKey)]}
  if(file.exists(file.path(path_foringest, "/dataGap.csv"))) {
    gap$DateLoadedInDb <- header$DateLoadedInDb[match(gap$PrimaryKey, header$PrimaryKey)]}
  if(file.exists(file.path(path_foringest, "/dataHeight.csv"))) {
    hgt$DateLoadedInDb <- header$DateLoadedInDb[match(hgt$PrimaryKey, header$PrimaryKey)]}
  if(file.exists(file.path(path_foringest, "/dataSoilStability.csv"))) {
    ss$DateLoadedInDb <- header$DateLoadedInDb[match(ss$PrimaryKey, header$PrimaryKey)]}
  if(file.exists(file.path(path_foringest, "/geoSpecies.csv"))) {
    sp$DateLoadedInDb <- header$DateLoadedInDb[match(sp$PrimaryKey, header$PrimaryKey)]}
  if(file.exists(file.path(path_foringest, "/dataSpeciesInventory.csv"))) {
    spin$DateLoadedInDb <- header$DateLoadedInDb[match(spin$PrimaryKey, header$PrimaryKey)]}



  write.csv(header,paste0(path_foringest,"/dataHeader.csv"), row.names=FALSE)
  write.csv(ind,paste0(path_foringest,"/geoIndicators.csv"), row.names=FALSE)

  if(file.exists(file.path(path_foringest, "/dataLPI.csv"))) {
    write.csv(LPI,paste0(path_foringest,"/dataLPI.csv"), row.names=FALSE)}
  if(file.exists(file.path(path_foringest, "/dataGap.csv"))) {
    write.csv(gap,paste0(path_foringest,"/dataGap.csv"), row.names=FALSE)}
  if(file.exists(file.path(path_foringest, "/dataHeight.csv"))) {
    write.csv(hgt,paste0(path_foringest,"/dataHeight.csv"), row.names=FALSE)}
  if(file.exists(file.path(path_foringest, "/dataSoilStability.csv"))) {
    write.csv(ss,paste0(path_foringest,"/dataSoilStability.csv"), row.names=FALSE)}
  if(file.exists(file.path(path_foringest, "/geoSpecies.csv"))) {
    write.csv(sp,paste0(path_foringest,"/geoSpecies.csv"), row.names=FALSE)}
  if(file.exists(file.path(path_foringest, "/dataSpeciesInventory.csv"))) {
    write.csv(spin,paste0(path_foringest,"/dataSpeciesInventory.csv"), row.names=FALSE)}



}
##############################################



